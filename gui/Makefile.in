prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
bindir = @bindir@
datadir = @datadir@
pkgdatadir = @datadir@/@PACKAGE_TARNAME@
mandir = @mandir@

top_builddir = @top_builddir@
top_srcdir = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@
@SET_MAKE@

CC = @CC@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@
DEFS = @DEFS@
GUI_LDFLAGS = @LDFLAGS@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@

GTK_CFLAGS = @GTK_CFLAGS@
GTK_LIBS = @GTK_LIBS@

TICALCS_CFLAGS = @TICALCS_CFLAGS@
TICALCS_LIBS = @TICALCS_LIBS@

TILEMCORE_CFLAGS = -I$(top_srcdir)/emu
TILEMCORE_LIBS = -L$(top_builddir)/emu -ltilemcore

TILEMDB_CFLAGS = -I$(top_srcdir)/db
TILEMDB_LIBS = -L$(top_builddir)/db -ltilemdb

DEF_SHARE_DIR = -DSHARE_DIR=\"$(pkgdatadir)\" \
	-DUNINSTALLED_SHARE_DIR=\"$(top_srcdir)/data\"

objects = tilem2.o \
	animatedgif.o \
	args.o \
	config.o \
	debugger.o \
	disasmview.o \
	emulator.o \
	event.o \
	files.o \
	gifencod.o \
	keybindings.o \
	link.o \
	macro.o \
	memmodel.o \
	memory.o \
	pbar.o \
	screen.o \
	screenshot.o \
	skin.o \
	skinops.o \
	ti81prg.o \
	tool.o

libs = $(TILEMDB_LIBS) $(TILEMCORE_LIBS) $(GTK_LIBS) $(TICALCS_LIBS) $(LIBS)

compile = $(CC) -I$(top_builddir) -I$(srcdir) $(CFLAGS) $(DEFS) \
	$(TILEMCORE_CFLAGS) $(TILEMDB_CFLAGS) \
	$(GTK_CFLAGS) $(TICALCS_CFLAGS)

link = $(CC) $(CFLAGS) $(LDFLAGS) $(GUI_LDFLAGS)

common_headers = ../config.h ../emu/tilem.h ../db/tilemdb.h \
	gui.h emulator.h debugger.h skinops.h debuginfo.h gtk-compat.h msgbox.h

all: tilem2@EXEEXT@

#Main emulator GUI
tilem2@EXEEXT@: $(objects) ../emu/libtilemcore.a
	$(link) -o tilem2@EXEEXT@ $(objects) $(libs)

tilem2.o: tilem2.c $(common_headers)
	$(compile) -c $(srcdir)/tilem2.c

# Debugger
debugger.o: debugger.c disasmview.h memmodel.h $(common_headers)
	$(compile) -c $(srcdir)/debugger.c

# Disassembly view
disasmview.o: disasmview.c disasmview.h $(common_headers)
	$(compile) -c $(srcdir)/disasmview.c

# Tree model interface for calc memory
memmodel.o: memmodel.c memmodel.h $(common_headers)
	$(compile) -c $(srcdir)/memmodel.c

# Memory management and messages
memory.o: memory.c ../emu/tilem.h
	$(compile) -c $(srcdir)/memory.c

# Main emulation loop
emulator.o: emulator.c $(common_headers)
	$(compile) -c $(srcdir)/emulator.c

# Print the skin and add the events. 
screen.o: screen.c $(common_headers)
	$(compile) -c $(srcdir)/screen.c

# Handle events
event.o: event.c $(common_headers)
	$(compile) -c $(srcdir)/event.c

# Open skin (skn format file) originally created by Julien Blache and Romain Lievins
skinops.o: skinops.c skinops.h 
	$(compile) -c $(srcdir)/skinops.c

# Manage skins
skin.o: skin.c files.h $(common_headers)
	$(compile) -c $(srcdir)/skin.c 

# Popups and other stuff
tool.o: tool.c $(common_headers)
	$(compile) -c $(srcdir)/tool.c

# Manage config.ini 
config.o: config.c files.h $(common_headers)
	$(compile) -c $(srcdir)/config.c

# Handle internal link
link.o: link.c ti81prg.h $(common_headers)
	$(compile) -c $(srcdir)/link.c

# Handle macro
macro.o: macro.c $(common_headers)
	$(compile) -c $(srcdir)/macro.c

# Handle args
args.o: args.c $(common_headers)
	$(compile) -c $(srcdir)/args.c

# Create and modify animated gif
gifencod.o: gifencod.c gifencod.h
	$(compile) -c $(srcdir)/gifencod.c

# Handle screenshot anim (animated gif)
animatedgif.o: animatedgif.c $(common_headers)
	$(compile) -c $(srcdir)/animatedgif.c

# Screenshot widget
screenshot.o: screenshot.c $(common_headers)
	$(compile) -c $(srcdir)/screenshot.c

# Progress bar widget
pbar.o: pbar.c $(common_headers)
	$(compile) -c $(srcdir)/pbar.c


# Shared/configuration files
files.o: files.c files.h
	$(compile) $(DEF_SHARE_DIR) -c $(srcdir)/files.c

# Keybindings
keybindings.o: keybindings.c files.h $(common_headers)
	$(compile) -c $(srcdir)/keybindings.c


# TI-81 program file functions
ti81prg.o: ti81prg.c ti81prg.h ../emu/tilem.h
	$(compile) -c $(srcdir)/ti81prg.c



install: testemu2
	chmod +x install.sh
	./install.sh
clean:
	rm -f *.o
	rm -f tilem2@EXEEXT@

.PHONY: all clean
